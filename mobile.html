<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>GeoArt Mobile Guide</title>
    <style>
        :root {
            --primary: #8b5cf6;
            --accent: #38bdf8;
            --success: #22c55e;
            --danger: #ef4444;
            --dark: #0f172a;
            --panel: #1e293b;
            --text: #f8fafc;
            --border: #334155;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--dark);
            color: var(--text);
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        .header {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            background: rgba(15, 23, 42, 0.98);
            border-bottom: 1px solid var(--border);
            z-index: 50;
            flex-shrink: 0;
        }

        /* BotÃ£o do Menu com PosiÃ§Ã£o Relativa para a bolinha */
        .toggle-btn { 
            background: none; border: 1px solid var(--border); color: white; 
            padding: 5px 10px; border-radius: 4px; font-size: 1.2rem; 
            position: relative; /* Importante para a bolinha */
            transition: 0.2s;
        }
        .toggle-btn:active { background: #334155; }

        /* A BOLINHA VERMELHA PISCANTE */
        .guide-dot {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 14px;
            height: 14px;
            background-color: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--dark); /* Borda para destacar */
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-red 1.5s infinite;
            pointer-events: none; /* Deixa o clique passar */
            z-index: 100;
        }

        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* LAYOUT GERAL */
        .app-container {
            position: relative;
            width: 100%;
            height: calc(100dvh - 50px);
            overflow: hidden;
        }

        /* MENU LATERAL (Overlay) */
        .sidebar {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 100px;
        }
        .sidebar.open { transform: translateY(0); }

        .panel-section { margin-bottom: 25px; }
        .panel-section h3 { margin: 0 0 12px 0; color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }

        /* CANVAS AREA */
        .canvas-wrapper {
            width: 100%; height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        canvas { width: 100%; height: 100%; object-fit: contain; }

        /* BARRA DE CONTROLES */
        .controls-bar {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(8px);
            border-top: 1px solid var(--border);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            overflow-x: auto;
            border-radius: 15px 15px 0 0;
            z-index: 50;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        .controls-bar::-webkit-scrollbar { display: none; }

        /* ELEMENTOS DE UI */
        .btn { padding: 10px 16px; border: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; color: white; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .btn-round { width: 50px; height: 50px; border-radius: 50%; justify-content: center; font-size: 1.4rem; flex-shrink: 0; }
        .btn-rec { background: var(--danger); }
        .btn-dl { background: var(--success); }
        .btn-opt { background: var(--panel); border: 1px solid var(--border); color: #cbd5e1; }
        .btn-opt.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .btn-block { width: 100%; margin-bottom: 8px; padding: 14px; justify-content: center; background: #334155; }
        
        .control-group { display: flex; flex-direction: column; gap: 4px; min-width: 100px; }
        .control-label { font-size: 0.7rem; color: #94a3b8; }
        select { background: #0f172a; color: white; border: 1px solid var(--border); padding: 8px; border-radius: 6px; width: 100%; }
        input[type=range] { width: 100%; accent-color: var(--accent); height: 24px; }

        /* Loader */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 20;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .loader-overlay.show { opacity: 1; pointer-events: all; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Checkboxes */
        .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .check-item { background: #334155; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        input[type=checkbox] { width: 20px; height: 20px; accent-color: var(--accent); }

        .recording { animation: pulse-rec 1.5s infinite; background: #991b1b !important; }
        @keyframes pulse-rec { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <header class="header">
        <button class="toggle-btn" id="menuBtn">
            â˜° OpÃ§Ãµes
            </button>
        <div style="font-weight:bold; background: linear-gradient(to right, #c084fc, #38bdf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">GeoArt Pro</div>
    </header>

    <div class="app-container">
        
        <div class="sidebar" id="sidebar">
            <h2 style="margin-top:0; color:white; font-size:1.2rem;">ConfiguraÃ§Ãµes</h2>
            
            <div class="panel-section">
                <h3>Fonte da Imagem</h3>
                <button class="btn btn-block" id="btnRandom" style="background: var(--warning); color: #000; font-weight:bold; font-size:1.1rem;">ðŸŽ² Trocar Imagem (AleatÃ³ria)</button>
                
                <label class="btn btn-block">
                    ðŸ“‚ Abrir da Galeria
                    <input type="file" id="fileInput" hidden accept="image/*">
                </label>
                
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <input type="text" id="searchInput" placeholder="Tema (ex: neon, gato)" style="flex:1; padding:10px; border-radius:6px; border:none;">
                    <button id="btnSearch" class="btn" style="background:var(--accent); color:black;">Ir</button>
                </div>
            </div>

            <div class="panel-section">
                <h3>Estilo</h3>
                <select id="paletteSelect" style="margin-bottom: 10px; padding: 12px;">
                    <option value="original">ðŸŽ¨ Cores Originais</option>
                    <option value="neon">ðŸ”® Neon Cyberpunk</option>
                    <option value="fire">ðŸ”¥ Fogo Intenso</option>
                    <option value="bw">âš« Preto e Branco</option>
                    <option value="matrix">ðŸ’» Matrix</option>
                </select>
                <div class="check-item">
                    <input type="checkbox" id="flowCheck">
                    <span>ðŸŒŠ Efeito LÃ­quido</span>
                </div>
            </div>

            <div class="panel-section">
                <h3>Formas</h3>
                <div class="check-grid" id="shapesContainer">
                    <label class="check-item"><input type="checkbox" value="circle" checked> Bolas</label>
                    <label class="check-item"><input type="checkbox" value="square" checked> Quadrados</label>
                    <label class="check-item"><input type="checkbox" value="line"> Riscos</label>
                    <label class="check-item"><input type="checkbox" value="triangle"> TriÃ¢ngulos</label>
                </div>
            </div>

            <button class="btn btn-block" onclick="toggleMenu()" style="background: transparent; border: 1px solid #555; margin-top:20px;">Fechar Menu</button>
        </div>

        <div class="canvas-wrapper" id="canvasWrapper">
            <div class="loader-overlay" id="loader">
                <div class="spinner"></div>
                <div style="color:white">Criando Arte...</div>
            </div>
            <canvas id="artCanvas"></canvas>
        </div>

        <div class="controls-bar">
            <button id="btnRec" class="btn btn-round btn-rec">ðŸ”´</button>
            <button id="btnSave" class="btn btn-round btn-dl">ðŸ’¾</button>
            
            <div style="width:1px; height:30px; background:var(--border); margin:0 5px;"></div>

            <div class="control-group">
                <span class="control-label">Velocidade</span>
                <input type="range" id="speedRange" min="10" max="100" value="60">
            </div>

            <button id="btnEvol" class="btn btn-opt active">âœ¨ EvoluÃ§Ã£o</button>
            
            <div class="control-group">
                <span class="control-label">DuraÃ§Ã£o</span>
                <select id="timeSelect" style="width: 90px;">
                    <option value="15000">15 seg</option>
                    <option value="30000" selected>30 seg</option>
                    <option value="60000">1 min</option>
                    <option value="90000">1:30 min</option>
                    <option value="9999999">Infinito</option>
                </select>
            </div>
        </div>

    </div>

    <script>
        // CONFIG
        const config = {
            width: 1080, height: 1920,
            isRunning: false,
            shapes: ['circle', 'square'],
            speed: 60,
            duration: 30000,
            evolution: true,
            flowField: false,
            palette: 'original',
            startTime: 0
        };

        const canvas = document.getElementById('artCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        let sourceData = null, sW = 0, sH = 0;
        let animationId = null;
        let flowAngles = [];

        function init() {
            canvas.width = config.width;
            canvas.height = config.height;
            
            // --- INSERÃ‡ÃƒO DA BOLINHA GUIA ---
            const menuBtn = document.getElementById('menuBtn');
            // Cria a bolinha
            const dot = document.createElement('div');
            dot.id = 'guideDot';
            dot.className = 'guide-dot';
            menuBtn.appendChild(dot);

            // Logica do botÃ£o menu
            menuBtn.onclick = () => {
                // Remove a bolinha na primeira vez que clicar
                const d = document.getElementById('guideDot');
                if(d) d.remove();
                
                toggleMenu();
            };

            // Eventos normais
            document.getElementById('btnRandom').onclick = () => loadUrl(`https://picsum.photos/1080/1920?random=${Date.now()}`);
            
            document.getElementById('btnSearch').onclick = () => {
                const term = document.getElementById('searchInput').value;
                if(term) loadUrl(`https://loremflickr.com/1080/1920/${encodeURIComponent(term)}?lock=${Date.now()}`);
            };

            document.getElementById('fileInput').onchange = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = (evt) => loadImg(evt.target.result);
                    r.readAsDataURL(f);
                }
            };

            document.getElementById('speedRange').oninput = (e) => config.speed = parseInt(e.target.value);
            document.getElementById('timeSelect').onchange = (e) => config.duration = parseInt(e.target.value);
            document.getElementById('btnEvol').onclick = (e) => { config.evolution = !config.evolution; e.target.classList.toggle('active'); };
            document.getElementById('paletteSelect').onchange = (e) => config.palette = e.target.value;
            document.getElementById('flowCheck').onchange = (e) => config.flowField = e.target.checked;
            
            const shapeChecks = document.querySelectorAll('#shapesContainer input');
            shapeChecks.forEach(ch => ch.onchange = () => {
                config.shapes = Array.from(shapeChecks).filter(c => c.checked).map(c => c.value);
                if(config.shapes.length === 0) config.shapes = ['circle'];
            });

            document.getElementById('btnSave').onclick = downloadImage;
            document.getElementById('btnRec').onclick = toggleRecord;

            // Inicia com uma imagem padrÃ£o
            loadUrl(`https://picsum.photos/1080/1920?random=start`);
        }

        function toggleMenu() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('open');
        }

        function toggleLoader(show) {
            document.getElementById('loader').classList.toggle('show', show);
        }

        // CARREGAMENTO
        function loadUrl(url) {
            toggleLoader(true);
            // Se o menu estiver aberto, fecha ele
            if(document.getElementById('sidebar').classList.contains('open')) toggleMenu();
            
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => loadImgObj(img);
            img.onerror = () => { alert("Erro na imagem."); toggleLoader(false); };
            img.src = url;
        }

        function loadImg(src) {
            toggleLoader(true);
            if(document.getElementById('sidebar').classList.contains('open')) toggleMenu();
            const img = new Image();
            img.onload = () => loadImgObj(img);
            img.src = src;
        }

        function loadImgObj(img) {
            sW = 540; sH = 960; 
            const oc = document.createElement('canvas');
            oc.width = sW; oc.height = sH;
            const octx = oc.getContext('2d');
            
            const ratio = Math.max(sW / img.width, sH / img.height);
            const cw = img.width * ratio;
            const ch = img.height * ratio;
            octx.drawImage(img, (sW - cw)/2, (sH - ch)/2, cw, ch);
            
            sourceData = octx.getImageData(0, 0, sW, sH).data;

            flowAngles = new Float32Array(sW * sH);
            for(let i=0; i<sW*sH; i++) {
                const r = sourceData[i*4];
                flowAngles[i] = (r / 255) * Math.PI * 2;
            }

            ctx.fillStyle = config.palette === 'original' ? '#111' : '#000';
            ctx.fillRect(0, 0, config.width, config.height);
            
            config.startTime = Date.now();
            config.isRunning = true;
            toggleLoader(false);
            if(animationId) cancelAnimationFrame(animationId);
            loop();
        }

        function loop() {
            if(!config.isRunning) return;

            const elapsed = Date.now() - config.startTime;
            if(config.duration < 9000000 && elapsed > config.duration) {
                config.isRunning = false; return;
            }

            const speedFactor = config.speed / 10; 
            const loops = Math.floor(speedFactor * 30); 

            let size = 30;
            if(config.evolution) {
                const progress = Math.min(elapsed / config.duration, 1);
                size = Math.max(150 * (1 - progress) + (Math.random()*10), 6); 
            } else {
                size = 20 + Math.random() * 20;
            }

            for(let i=0; i<loops; i++) {
                const rx = Math.floor(Math.random() * sW);
                const ry = Math.floor(Math.random() * sH);
                const idx = (ry * sW + rx) * 4;

                const r = sourceData[idx]; const g = sourceData[idx+1]; const b = sourceData[idx+2];
                const x = (rx / sW) * config.width;
                const y = (ry / sH) * config.height;

                const color = getColor(r, g, b);
                ctx.fillStyle = color; ctx.strokeStyle = color;

                const angle = config.flowField ? flowAngles[ry*sW+rx] : Math.random() * 6.28;
                const brightness = (r+g+b)/3;
                const finalSize = size * (0.6 + (brightness/255));

                drawShape(x, y, finalSize, config.shapes[Math.floor(Math.random()*config.shapes.length)], angle);
            }
            animationId = requestAnimationFrame(loop);
        }

        function drawShape(x, y, size, type, angle) {
            ctx.beginPath();
            if(type === 'circle') { ctx.arc(x, y, size/2, 0, Math.PI*2); ctx.fill(); } 
            else if(type === 'square') { ctx.save(); ctx.translate(x,y); ctx.rotate(angle); ctx.fillRect(-size/2, -size/2, size, size); ctx.restore(); }
            else if(type === 'line') { ctx.lineWidth = Math.max(2, size/4); ctx.moveTo(x - Math.cos(angle)*size, y - Math.sin(angle)*size); ctx.lineTo(x + Math.cos(angle)*size, y + Math.sin(angle)*size); ctx.stroke(); }
            else if(type === 'triangle') { ctx.save(); ctx.translate(x,y); ctx.rotate(angle); ctx.moveTo(0, -size/2); ctx.lineTo(size/2, size/2); ctx.lineTo(-size/2, size/2); ctx.closePath(); ctx.fill(); ctx.restore(); }
        }

        function getColor(r, g, b) {
            if(config.palette === 'original') return `rgb(${r},${g},${b})`;
            const lum = (r*0.299 + g*0.587 + b*0.114) / 255;
            if(config.palette === 'bw') { const v = lum * 255; return `rgb(${v},${v},${v})`; }
            if(config.palette === 'neon') return `hsl(${lum * 300}, 100%, 60%)`;
            if(config.palette === 'fire') return lum < 0.5 ? `rgb(${lum*510},0,0)` : `rgb(255,${(lum-0.5)*510},0)`;
            if(config.palette === 'matrix') return `rgb(0, ${Math.floor(lum*255)}, 0)`;
            return `rgb(${r},${g},${b})`;
        }

        function downloadImage() {
            const a = document.createElement('a'); a.download = 'GeoArt_' + Date.now() + '.png'; a.href = canvas.toDataURL(); a.click();
        }

        let mediaRecorder = null; let chunks = [];
        function toggleRecord() {
            const btn = document.getElementById('btnRec');
            if(mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); btn.classList.remove('recording'); } 
            else {
                try {
                    const stream = canvas.captureStream(30); mediaRecorder = new MediaRecorder(stream); chunks = [];
                    mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
                    mediaRecorder.onstop = () => { const b = new Blob(chunks, {type:'video/webm'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href=u; a.download='GeoVideo.webm'; a.click(); };
                    mediaRecorder.start(); btn.classList.add('recording');
                } catch(e) { alert("GravaÃ§Ã£o nÃ£o suportada."); }
            }
        }

        init();
    </script>
</body>
</html>
